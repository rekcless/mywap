<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="style.css">
<title>Baca Post</title>
</head>

<body>
<header id="title">Loading...</header>

<div class="container">
  <img id="thumb" style="width:100%;border-radius:12px;display:none">

  <div class="meta" id="category"></div>
  <p id="body"></p>

  <a id="download" class="btn" target="_blank">Download</a>

  <h3>Komentar</h3>
  <div id="comments" class="comment-box"></div>

  <input id="cName" placeholder="Nama" style="width:100%;margin-top:10px">
  <textarea id="cText" placeholder="Komentar..." style="width:100%;margin-top:8px"></textarea>
  <button onclick="sendComment()" class="btn" style="margin-top:10px">Kirim</button>
</div>

<script type="module">
  import { db } from "./firebase.js";

  import {
    doc, getDoc, updateDoc, increment,
    collection, addDoc,
    query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const id = new URLSearchParams(location.search).get("id");

  async function loadPost() {
    const ref = doc(db, "posts", id);
    const snap = await getDoc(ref);
    if (!snap.exists()) return;

    const p = snap.data();

    title.textContent = p.title;
    category.textContent = p.category;
    body.innerHTML = p.body.replace(/\n/g, "<br>");

    if (p.thumbnailUrl) {
      thumb.src = p.thumbnailUrl;
      thumb.style.display = "block";
    }

    if (p.downloadUrl) download.href = p.downloadUrl;
    else download.style.display = "none";

    updateDoc(ref, { views: increment(1) });
  }

  loadPost();

  // COMMENTS REALTIME
  const comRef = collection(db, "comments", id, "items");
  const q = query(comRef, orderBy("createdAt", "asc"));

  onSnapshot(q, snap => {
    let html = "";
    snap.forEach(d => {
      const c = d.data();
      html += `<div class="comment"><b>${c.name}:</b> ${c.text}</div>`;
    });
    comments.innerHTML = html;
  });

  window.sendComment = async function() {
    await addDoc(comRef, {
      name: cName.value,
      text: cText.value,
      createdAt: new Date()
    });
    cText.value = "";
  }
</script>
</body>
</html>